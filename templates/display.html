 <!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/.  -->
{% extends "base_s.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}


{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/display.css') }}">
<script type="text/javascript" src="{{ url_for('static', filename='jsonstream.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='audiosequence.min.js') }}"></script>
<script src="{{ url_for('static', filename='extFunctions.js') }}" type='text/javascript'></script>
<script type='text/javascript'>
	var announcement_texts = undefined
	var singleRowQueuing = !!"{% if settings.single_row %}on{% endif %}"
	var audioNotification = "{{'/static/multimedia/'+ts.audio}}"
	var playAudioNotification = '{{ ts.audio}}' != 'false'
	var playAnnouncements = '{{ ts.announce }}' !== 'false'
	var waitForEnding = '{{ ts.wait_for_announcement }}' === 'True'
	var languages = "{{ ts.announce }}".split(',')
	var refreshRate = parseInt("{{ ts.rrate }}")
	var repeats = parseInt("{{ ts.anr }}")
	var repeatType = "{{ ts.anrt }}"
	var Player = new AudioSequence({
		repeats: repeats,
		repeat_whole: repeatType === 'whole',
		repeat_each: repeatType === 'each',
		auto_start: true,
		autoplay_warning: playAudioNotification || playAnnouncements,
	})
	var processedRepeats = {};

	function play (files) {
		if (files.length) {
			$('video').prop('muted', true)
			if (waitForEnding) Player.playAfter(files)
			else {
				Player.files = files
				Player.load()
			}
		}
	}

	Player.doAfter(function() { $('video').prop('muted', false) })
	reloadIf(window.location.href, refreshRate)
	$.getJSON("{{ url_for('static', filename='tts.json') }}")
		.then(function(j) {
			announcement_texts = j
			if (announcement_texts) {
			
            Object.keys(announcement_texts).forEach(function(lang) {
                if (announcement_texts[lang] && announcement_texts[lang].message) {
				
                    announcement_texts[lang].message = announcement_texts[lang].message
                        .replace(/{}/g, "{{ alias.office }}");
                }
            });
            }
		})

	var render_streamed_data= function(item, i,emptyText,stream_tag,what_in_item){
		var $el = null;
        var slotNames = [stream_tag + (i + 1)];
        
        for (var si = 0; si < slotNames.length; si++) {
            $el = $('[stream="' + slotNames[si] + '"]');
            if ($el.length) break;
            }

        if (!$el || !$el.length) {
            // slot not present in this template; skip
            return;
            }

        if (!item) {
            $el.text(emptyText);
            $el.removeAttr('title');
            return;
            }
    
        var content = item[what_in_item] || emptyText;
        $el.text(content);
		return $el;

	}
    
	var stream = JsonStream({
		url: "{{ feed_url }}",
		duration: refreshRate / 1000,
		effect_duration: parseInt("{{ ts.mduration }}"),
		data_attr: 'stream',
		effect_repeats: parseInt("{{ ts.repeats }}"),
		use_effect: 'true',
		use_effect_do: 'true',
		effect: "{{ ts.effect }}",
		ensure_value: 'w9',
		todo: function (data, toPlay) {
			var emptyText = "{{ translate('Empty', 'en', [defLang]) }}";

            // --- Pulled tickets handler (runs for every update)
            (function updatePulledSection() {
                try {
                    if (!data.pulled || !Array.isArray(data.pulled)) {
                    // nothing to do
                    return;
                    }

                    // small delay so JsonStream's own DOM writes finish first
                    setTimeout(function () {
                        try {
                            var pulled = data.pulled.slice(0, 9); // limit to 9 slots
                            var emptyText = "{{ translate('Empty', 'en', [defLang]) }}";

                            for (var i = 0; i < 9; i++) {
                                var item = pulled[i] || null;

								// Render text
								var $el = render_streamed_data(item, i,emptyText, 'user_name','name');
								
								var $el2 = render_streamed_data(item, i,emptyText, 'pulled_by','pulled_by');
                                
                            } // end of for loop

                        // debug: optionally log updates (uncomment to debug)
                        // console.log('Pulled slots updated', pulled);

                        } catch (innerErr) {
                            console.error('pulled update inner error', innerErr);
                        }
                    }, 40); // 40ms delay — small but helps avoid race with JsonStream DOM writes

                } catch (err) {
                    console.error('pulled update error', err);
                }
            })();
            // --- end pulled tickets handler
			
			if (announcement_texts) {
		        if(data.cot=='Empty' || data.con=='Empty') {
					return;
				}
				if (playAnnouncements) {
					$.when.apply($, languages.map(function(language, index) {
						var promise = $.Deferred()
						var message = announcement_texts[language].message
						var link = '/gtts/' + language + '/'

						if (singleRowQueuing) link += data.cot
						else link += data.cot + message + data.cpbn

						if (!data.con || !data.cot) promise.reject()
						else $.get(link)
							.then(function(json) { promise.resolve(json.mp3) })
							.fail(function(e) { promise.reject(e) })

						return promise
					}))
					.then(function() {
						var files = $.makeArray(arguments).sort()

						if (playAudioNotification) files.unshift(audioNotification)
						play(files)
					}).fail(function (e) { console.log(e) })
				} else if (playAudioNotification) play([audioNotification])
			} 
		}

		
	})

	var watcher = setInterval(function () {
		var url = '/repeat_announcement'
		var officeId = '{{ office_id }}'

		if (officeId !== 'None') url += '/' + officeId

		$.get(url)
			.then(function (j) {
				if (j.status && !processedRepeats[j.id]) {
					console.log(processedRepeats);
					play(Player.files)
					processedRepeats[j.id] = true
				}
			})
			.fail(function (e) { console.log(e) })
	}, refreshRate / 2)

</script>
<style>
	body {
		{% if ts.bgcolor[:3] == "rgb" %}
		background: {{ ts.bgcolor }};
		{% else %}
		background-image: url({{ url_for('static', filename='multimedia/'+ts.bgcolor) }});
		{% endif %}
		background-repeat: no-repeat;
		background-attachment: fixed;
		background-position: center;
		background-size: cover;
	}
	.vertical-center {
		min-height: 100%;
		min-height: 100vh;
		display: flex;
		align-items: center;
	}
	.title {
		color: {{ ts.hcolor }};
		background: {{ ts.hbg }};
		font-size: {{ ts.hsize }};
		font-family: '{{ ts.hfont }}';
	}
	.offices {
		color: {{ ts.tcolor }};
		font-family: '{{ ts.tfont }}';
		font-size: {{ ts.tsize }};
		background: {{ ts.hbg }};
	}
	.tasks {
		color: {{ ts.h2color }};
		font-family: '{{ ts.h2font }}';
		font-size: {{ ts.h2size }};
		background: {{ ts.hbg }};
	}
	.slideDim {
		height: 600px;
		width: 1300px;
	}
	.tickets {
		color: {{ ts.scolor }};
		font-family: {{ ts.sfont }};
		font-size: {{ ts.ssize }};
		background: {{ ts.hbg }};
	}
	.inline {
		display: inline-block;
	}
	.scroll-item {
        display: inline-block;
        padding: 0 40px;

        /* MATCH ORIGINAL WAITING TICKET STYLE */
        font-family: {{ ts.sfont }};
        font-size: {{ ts.ssize }};
        color: {{ ts.scolor }};
        background: {{ ts.hbg }};
        border-radius: 8px;

        /* improves readability on dark backgrounds */
        font-weight: bold;
        text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
    }

    /* === ULTRA HIGH VISIBILITY TV TABLE (NO hover) === */

    .tickets-table {
        width: 90%;
        margin: 30px auto;
        border-collapse: collapse;
        font-weight: bold;
    }

    /* HEADER */
    .tickets-table th {
        background: #ffffff;      /* bright white */
        color: #000000;           /* pure black text */
        font-size: 220%;
        padding: 25px 20px;
        text-align: center;
        border-bottom: 4px solid #888;
    }

    /* EVEN ROWS (LIGHT background, DARK text) */
    .tickets-table tr:nth-child(even) td {
        background: #eeeeee;      /* light grey */
        color: #000000;           /* black text */
        font-size: 260%;
        padding: 30px 20px;
        text-align: center;
    }

    /* ODD ROWS (DARK background, LIGHT text) */
    .tickets-table tr:nth-child(odd) td {
        background: #111111;      /* near-black row */
        color: #ffffff;           /* white text */
        font-size: 260%;
        padding: 30px 20px;
        text-align: center;
    }

    /* Row separators */
    .tickets-table td {
        border-bottom: 3px solid #444;
    }

</style>


{% if tv == 0 %}
<div class="row">
    <div class="col-xs-12 text-center">
		<h1 class='mt-1 mb-1 title'> {{ ts.title }} </h1>
    </div>
</div>
<div class="row mt-1">
    <div class="{% if sli.status == 1 or vid.enable == 1 %} col-xs-4 {% else %} col-xs-12 {% endif %} text-center">
		{% if not settings.single_row %}
		<h1 class='offices mb-1'>
			{% if alias.office != 'Office' %}{{ alias.office }}{% else %}{{ translate('Office', 'en', [defLang]) }}{% endif %} : 
			<p stream='con' class='effectit ensureit inline'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
      	<h1 class='tasks mb-1'>
			{% if alias.task != 'Task' %}{{ alias.task }}{% else %}{{ translate('Task', 'en', [defLang]) }}{% endif %} : 
			<p class='effectit ensureit inline' stream='cott'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
		{% endif %}
	    <h1 class='tasks mb-1'>
			{% if alias.ticket != 'Ticket' %}{{ alias.ticket }}{% else %}{{ translate('Ticket', 'en', [defLang]) }}{% endif %} : 
			<p class='effectdoit ensureit inline' stream='cot'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	</div>
	{% if sli.status == 1 %}
	<div class="col-xs-8">
	    {% if slides.count() >= 1 %}
		<div id="carousel" data-interval="{{ sli.rotation }}" 
			class="carousel slide {% if sli.effect == 'fade' %} carousel-fade {% endif %}" data-ride="carousel"
		>
	    	<ol class="carousel-indicators">
				{% for vv in range(0, slides.count()) %}
				<li class="{% if vv == 0 %} active {% endif %}" data-target="#carousel" data-slide-to="{{ vv }}"></li>
				{% endfor %}
	    	</ol>
	    	<div class="carousel-inner">
				{% for cc in slides %}
				<div class="item {% if cc.id == slides.first().id %} active {% endif %}">
					{% if cc.bname[:3]=="rgb" %}
					<span class="img-responsive slideDim" style="background:{{ cc.bname }};"></span>
					{% else %}
					<img src="{{ url_for('static', filename='multimedia/'+cc.bname) }}" class="img-responsive slideDim">
					{% endif %}
					<div class="carousel-caption">
			    		<h2 style="color: {{ cc.hcolor }}; font-family: {{ cc.hfont }}; font-size: {{ cc.hsize }}; background: {{ cc.hbg }};">{{ cc.title }}</h2>
			    		<p style="color: {{ cc.tcolor }}; font-family: {{ cc.tfont }}; font-size: {{ cc.tsize }}; background: {{ cc.hbg }};">{{ cc.subti }}</p>
					</div>
		    	</div>
		    	{% endfor %}
			</div>
			{% if sli.navigation == 1 %}
			<a class="left carousel-control" href="#carousel" data-slide="prev">
				<i class="icon-prev fa fa-angle-left"></i>
			</a>
			<a class="right carousel-control" href="#carousel" data-slide="next">
				<i class="icon-next fa fa-angle-right"></i>
			</a>
			{% endif %}
	    </div>
		{% else %}
				<h1 class="text-center text-danger bg-muted" style="font-size: 400%">
	    			{{ translate('No slides to be displayed', 'en', [defLang]) }}
				</h1>
		{% endif %}
	</div>  
	{% elif vid.enable == 1 %}
	<div class="col-xs-8">
		<center>
			<video id='vidd' class='img-responsive'
				src="{{ url_for('static', filename='multimedia/'+vid.vname) }}"
				autoplay
				{% if vid.controls == 1 %} controls {% endif %}
				{% if vid.ar == 1 %} loop {% endif %}
				{% if vid.mute == 1 %} muted {% endif %}
			></video>
		</center>
	</div>
	{% endif %}
</div>

<div class="row text-center mt-1">
	<div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w1'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w2'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w3'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w4'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
{% if sli.status == 2 and vid.enable == 2 %}
<div class="row text-center mt-1">
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w5'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w6'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w7'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
    	<h1 class='tickets'>
			<p class='watchit inline' stream='w8'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
{% endif %}


{% elif tv == 1 %}
<!-- Keep this hidden streams section so jsonstream does not break because of not having these streams -->
<div id="hidden-streams" aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;">
  <span stream="con" class="effectit ensureit">Empty</span>
  <span stream="cott" class="effectit ensureit">Empty</span>
  <span stream="cot" class="effectdoit ensureit">Empty</span>
</div>
<!-- ✅ Pulled tickets section -->
<table class="table table-bordered table-striped tickets-table">
    <thead>
        <tr>
            <th>Token Number</th>
            <th>Assigned Counter</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td stream="user_name1">{{ translate('Empty', 'en', [defLang]) }}</td>
            <td stream="pulled_by1">{{ translate('Empty', 'en', [defLang]) }}</td>
        </tr>
        <tr>
            <td stream="user_name2">{{ translate('Empty', 'en', [defLang]) }}</td>
            <td stream="pulled_by2">{{ translate('Empty', 'en', [defLang]) }}</td>
        </tr>
        <tr>
            <td stream="user_name3">{{ translate('Empty', 'en', [defLang]) }}</td>
            <td stream="pulled_by3">{{ translate('Empty', 'en', [defLang]) }}</td>
        </tr>
        <tr>
            <td stream="user_name4">{{ translate('Empty', 'en', [defLang]) }}</td>
            <td stream="pulled_by4">{{ translate('Empty', 'en', [defLang]) }}</td>
        </tr>
    </tbody>
</table>

<div class="scroll-container">
  <div class="scroll-content">
    <p class="watchit inline scroll-item" stream="w1"></p>
    <p class="watchit inline scroll-item" stream="w2"></p>
    <p class="watchit inline scroll-item" stream="w3"></p>
    <p class="watchit inline scroll-item" stream="w4"></p>
    <p class="watchit inline scroll-item" stream="w5"></p>
    <p class="watchit inline scroll-item" stream="w6"></p>
    <p class="watchit inline scroll-item" stream="w7"></p>
    <p class="watchit inline scroll-item" stream="w8"></p>
  </div>
</div>


{% elif tv == 2 %}
<div class="row vertical-center text-center">
    <div class="col-xs-6">
		  <h1 class='title mb-10'> {{ ts.title }} </h1>
		{% if not settings.single_row %}
		<h1 class='offices mb-5'>
			{% if alias.office != 'Office' %}{{ alias.office }}{% else %}{{ translate('Office', 'en', [defLang]) }}{% endif %} : 
			<p stream='con' class='effectit ensureit inline'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
      	<h1 class='tasks mb-5'>
					{% if alias.task != 'Task' %}{{ alias.task }}{% else %}{{ translate('Task', 'en', [defLang]) }}{% endif %} : 
			<p class='effectit ensureit inline' stream='cott'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
		{% endif %}
		<h1 class='tasks'>
			{% if alias.ticket != 'Ticket' %}{{ alias.ticket }}{% else %}{{ translate('Ticket', 'en', [defLang]) }}{% endif %} : 
			<p class='effectdoit ensureit inline' stream='cot'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w1'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w2'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w3'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
		<h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w4'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w5'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w6'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	    <h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w7'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
		<h1 class='tickets mb-10'>
			<p class='watchit inline' stream='w8'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>


{% elif tv == 3 %}
<div class="row">
    <div class="col-xs-12 text-center">
		<h1 class='title mt-1 mb-1'> {{ ts.title }} </h1>
    </div>
</div>
<div class="row text-center mt-5">
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w1'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w2'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w3'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='w4'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
<div class="row text-center mt-5">
	{% if not settings.single_row %}
    <div class="col-xs-4">
	    <h1 class='offices'>
				{% if alias.office != 'Office' %}{{ alias.office }}{% else %}{{ translate('Office', 'en', [defLang]) }}{% endif %} : 
				<p stream='con' class='effectit ensureit inline'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	</div>
    <div class="col-xs-4">
      	<h1 class='tasks'>
					{% if alias.task != 'Task' %}{{ alias.task }}{% else %}{{ translate('Task', 'en', [defLang]) }}{% endif %} : 
			<p class='effectit ensureit inline' stream='cott'>{{ translate('Empty', 'en', [defLang]) }}</p>
	  	</h1>
	</div>
	{% endif %}
    <div class="col-xs-4">
	    <h1 class='tasks'>
			{% if alias.ticket != 'Ticket' %}{{ alias.ticket }}{% else %}{{ translate('Ticket', 'en', [defLang]) }}{% endif %} : 
			<p class='effectdoit ensureit inline' stream='cot'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
</div>
<div class="row text-center mt-5">
    <br>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='p1'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='p2'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='p3'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
    </div>
    <div class="col-xs-3">
		<h1 class='tickets'>
			<p class='watchit inline' stream='p4'>{{ translate('Empty', 'en', [defLang]) }}</p>
		</h1>
	</div>
</div>
{% endif %}
{% endblock %}
