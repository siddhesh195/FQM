{% extends "base.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}

{% block page_content %}
<div id="app" class="container" style="margin-top: 20px;">

    <div class="row">
        <div class="col-xs-12">
            <h2 style="margin-top: 0;">{{ page_title }}</h2>

            <button class="btn btn-default btn-sm pull-right"
                    @click="fetch_reports"
                    v-if="!loading">
                Refresh
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div v-if="loading" class="alert alert-info" style="margin-top:10px;">
        Loading statisticsâ€¦
    </div>

    <!-- Error -->
    <div v-if="error" class="alert alert-danger" style="margin-top:10px;">
        [[ error ]]
    </div>

    <!-- No Data -->
    <div v-if="!loading && !error && officeRows.length === 0"
         class="alert alert-warning" style="margin-top:10px;">
        No statistics available.
    </div>

    <!-- Statistics Table -->
    <div v-if="officeRows.length" style="margin-top:15px;">
        <table class="table table-bordered table-striped">
            <thead>
                <tr class="active">
                    <th>Office</th>
                    <th class="text-right">Total</th>
                    <th class="text-right">Attended</th>
                    <th class="text-right">Processed</th>
                    <th class="text-right">Unattended</th>
                    <th class="text-right">Waiting</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="office in officeRows" :key="office.officeName">
                    <td><strong>[[ office.officeName ]]</strong></td>
                    <td class="text-right">[[ office.total_count ]]</td>
                    <td class="text-right">[[ office.attended_count ]]</td>
                    <td class="text-right">[[ office.processed_count ]]</td>
                    <td class="text-right">[[ office.unattended_count ]]</td>
                    <td class="text-right">[[ office.waiting_count ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>
{% endblock %}


{% block scripts %}


<script>
const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],

    data() {
        return {
            statistics: null,
            loading: true,
            error: null
        };
    },

    computed: {
        // Convert your JSON into an array Vue can iterate
        officeRows() {
            if (!this.statistics || !this.statistics.statistics_by_office_name) {
                return [];
            }
            const offices = this.statistics.statistics_by_office_name;

            return Object.entries(offices).map(([officeName, stats]) => ({
                officeName,
                attended_count: stats.attended_count,
                processed_count: stats.processed_count,
                total_count: stats.total_count,
                unattended_count: stats.unattended_count,
                waiting_count: stats.waiting_count
            }));
        }
    },

    methods: {
        fetch_reports() {
            this.loading = true;
            this.error = null;

            const url = "{{ url_for('reports.reports_data') }}";

            axios.get(url)
                .then(response => {
                    this.statistics = response.data;
                })
                .catch(err => {
                    console.error(err);
                    this.error = "Failed to load statistics.";
                })
                .finally(() => {
                    this.loading = false;
                });
        }
    },

    mounted() {
        this.fetch_reports();  // Auto-load once
    }
}).mount('#app');
</script>
{% endblock %}
