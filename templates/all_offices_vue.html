{% extends "base.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}


{%- from "sb_manage2.html" import sb_manage with context %}
{% block sidebar %}
 {{ sb_manage() }}
{% endblock %}

{% block page_content %}
    <div>
        <input
            type="text"
            class="form-control"
            placeholder="Search tickets..."
            v-model="searchQuery"
            style="width: 250px;"
        >
    </div>

    <table class="table table-bordered table-striped table-sm">
        <thead>
            <tr>
                <th v-for="col in columns" :key="col.label">
                    [[ col.label ]]
                </th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="row in paginatedRows" :key="row.id || row.name + '-' + row.number">
                <td>[[ row.name ]]</td>
                <td>[[ row.number ]]</td>
                <td>[[ row.office_name ]]</td>
                <td>[[ row.task_name ]]</td>
                <td>[[ givestatus(row.status) ]]</td>
                <td>[[ row.pulled_by ]]</td>
                <td>[[ row.timestamp ]]</td>
                <td>
                    <a @click="EditTicket(row.name)" >
                        <span class="mr-1 fa fa-pencil text-warning">
                        </span>
                    </a>

                    <a @click="PullTicket(row.name,row.office_id,row.ticket_id)" >
                        <span class="fa fa-minus text-primary"></span>
                    </a>
                </td>
            </tr>
            <tr v-if="paginatedRows.length === 0">
                <td :colspan="columns.length" class="text-center">
                    No data
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation" class="d-flex justify-content-between align-items-center">
        <div>
            Page [[ currentPage ]] of [[ totalPages ]]
        </div>

        <ul class="pagination mb-0">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <button class="page-link" @click="prevPage" :disabled="currentPage === 1">
                    Prev
                </button>
            </li>

            <li
                class="page-item"
                v-for="page in totalPages"
                :key="page"
                :class="{ active: page === currentPage }"
            >
                <button class="page-link" @click="goToPage(page)">
                    [[ page ]]
                </button>
            </li>

            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <button class="page-link" @click="nextPage" :disabled="currentPage === totalPages">
                    Next
                </button>
            </li>
        </ul>
    </nav>

{% endblock %}



   

{% block vue_data %}
    searchQuery: '',
    // pagination
    currentPage: 1,
    perPage: 10,
    rows: [],
    columns: [
            { label: 'Token'},
            { label: 'Serial Number'},
            { label: 'Office'},
            { label: 'Task'},
            { label: 'Status'},
            { label: 'Pulled By'},
            { label: 'Time'},
            { label: 'Actions'}
        ],
    openProcessTicketDialog_var: null,
    status_choices: {{ status_choices|tojson }},
    csrf_token: "{% if form and form.csrf_token is defined %}{{ form.csrf_token._value() }}{% endif %}",
    active_tickets_number: '',
    active_tickets_office: {},
    active_tickets_task_by_office: {},
    office_ids: {{ office_ids }},
    task_ids: {{ task_ids }},
{% endblock %}


{% block vue_methods%}
    pullnextTicket(o_id=null,ofc_id=null) {
        axios.post("{{ url_for('offices.pull_next_ticket') }}", {
            o_id: o_id,
            ofc_id: ofc_id
        })
        .then(response => {
            this.fetchData();  // Refresh data after pulling
            if (response.data.status === 'success') {
                showSwalMessage(response.data.message);
            } else {
                showSwalMessage("Error: " + response.data.message);
            }
        })
        .catch(error => {
            console.error("Error pulling ticket:", error);
        });
    },

    async submitTicketForm(ticketName) {
        const formData = await this.openProcessTicketDialog_var(this.status_choices);
        if (!formData) {
            return;
        }
        const response = await axios.post("{{ url_for('offices.update_token_details') }}",{
            ticket_name: ticketName,
            status: formData.status,
            csrf_token: this.csrf_token
        });
        if (response.data.status === 'success') {
            showSwalMessage(response.data.message);
        } else {
            showSwalMessage("Error: " + response.data.message);
        }
    },

    PullTicket(ticketName,officeId,ticketId) {
              
        axios.post("{{ url_for('offices.pull_ticket') }}", {
            ticket_name: ticketName,
            office_id: officeId,
            ticket_id: ticketId
        })
        .then(response => {
            this.fetchData();  // Refresh data after pulling
            if (response.data.status === 'success') {
                showSwalMessage("Successfully pulled ticket: " + ticketName);
            } else {
                showSwalMessage("Error: " + response.data.message);
            }
        })
        .catch(error => {
            console.error("Error pulling ticket:", error);
        });
    },

    fetchData() {
        axios.post("{{ url_for('offices.all_offices_tickets') }}",{
            o_id: {% if office_id is not none %}{{ office_id }}{% else %}null{% endif %}
        })
        .then(response => {
            this.rows = response.data;
        })
        .catch(error => {
            console.error("Error fetching data:", error);
        });      
    },

    goToPage(page) {
        if (page < 1 || page > this.totalPages) return;
        this.currentPage = page;
    },

    nextPage() {
        this.goToPage(this.currentPage + 1);
    },

    prevPage() {
        this.goToPage(this.currentPage - 1);
    },

    async EditTicket(ticketName) {
        // Open modal logic here
        const response = await this.submitTicketForm(ticketName);
    },
    getTaskActiveTickets(officeId) {
        for (const task_id of this.task_ids) {
            this.getNumberOfActiveTicketsTask(task_id, officeId);
        }
    },
                        
    getOfficeActiveTickets() {
        for (const office_id of this.office_ids) {
           this.getNumberOfActiveTicketsOffice(office_id);
           this.getTaskActiveTickets(office_id);
        }
    },
    getNumberOfActiveTicketsOffice(office_id=null) {
        axios.post("{{ url_for('offices.get_all_active_office_tickets') }}",{
            o_id: office_id
        })
        .then(response => {
            this.active_tickets_office[office_id] = response.data.active_tickets;
        })
        .catch(error => {
            console.error("Error fetching active tickets:", error);
        });
    },
    getNumberOfActiveTickets() {
        axios.get("{{ url_for('offices.get_all_active_tickets') }}")
        .then(response => {
            this.active_tickets_number = response.data.active_tickets;
        })
        .catch(error => {
            console.error("Error fetching active tickets:", error);
        });
    },

    getNumberOfActiveTicketsTask(task_id=null, office_id=null) {
        axios.post("{{ url_for('offices.get_all_active_task_tickets') }}",{
            t_id: task_id,
            office_id: office_id
        })
        .then(response => {
            // Handle the response if needed
            if(!this.active_tickets_task_by_office[office_id]){
                this.active_tickets_task_by_office[office_id] = {};
            }
            this.active_tickets_task_by_office[office_id][task_id] = response.data.active_tickets;
        })
        .catch(error => {
            console.error("Error fetching active task tickets:", error);
        });
    },
    givestatus(status){
        if( status == 'Waiting'){
            return 'Waiting to be pulled';
        }
        else if( status == 'Attended'){
            return 'Processing';
        }
        else if( status == 'Processed'){
            return 'Processed';
        }
        else{
            return 'Unknown';
        }
    }

{% endblock %}

{% block vue_computed %}

    totalPages() {
        return this.rows.length === 0
        ? 1
        : Math.ceil(this.rows.length / this.perPage);
    },

    filteredRows() {
        // no search â†’ return all rows
        if (!this.searchQuery) {
            return this.rows;
        }

        const q = this.searchQuery.toLowerCase();

        return this.rows.filter(row => {
            return [
                row.name,
                row.number,
                row.office_name,
                row.task_name,
                row.status,
                row.pulled_by,
                row.timestamp
            ] 
            .filter(v => v !== null && v !== undefined)
            .some(v => String(v).toLowerCase().includes(q));
        });
    },

    paginatedRows() {
        const start = (this.currentPage - 1) * this.perPage;
        const end   = start + this.perPage;
        return this.filteredRows.slice(start, end);
    }

{% endblock %}

{% block vue_mounted %}
    this.fetchData();
    this.intervalId = setInterval(this.fetchData, 2000)
    this.intervalId2 = setInterval(this.getNumberOfActiveTickets, 2000)
    this.intervalId3 = setInterval(this.getOfficeActiveTickets, 2000)
    this.openProcessTicketDialog_var = openProcessTicketDialog;

{% endblock %}

{% block vue_before_unmount %}
    clearInterval(this.intervalId);
    clearInterval(this.intervalId2);
    clearInterval(this.intervalId3);

{% endblock %}
                    

{% block scripts %}

{% endblock %}
