{% extends "base.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}

{% block head %}
 {{ super() }}
   
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all_offices_vue.css') }}">
   
{% endblock %}
{%- from "sb_manage2.html" import sb_manage with context %}
{% block sidebar %}
 {{ sb_manage() }}
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <div class="table-container">
        <div class="search-wrapper">
              <input
                type="text"
                class="form-control"
                placeholder="Search tickets..."
                v-model="searchQuery"
                style="width: 250px;"
               >
        </div>
        {% if current_user.role_id == 1 and not office_id %}
       
        <button class="btn btn-primary" @click="resetAllOffices">
            Reset All Offices
        </button>
    
        <button class="btn btn-danger" @click="deleteAllOfficesAndTasks">
            Delete All Offices and Tasks
        </button>
        {% elif current_user.role_id == 1 and office_id %}
        <button class="btn btn-primary" @click="resetOneOffice({{ office_id }})" >
            Reset this Office
        </button>
    
 

        {% endif %}
        <br>
        <br>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th v-for="col in columns" :key="col.label">
                            [[ col.label ]]
                        </th>
                    </tr>
                </thead>
        
                <tbody>
                    <tr v-for="row in paginatedRows" :key="row.id || row.name + '-' + row.number">
                        <td>[[ row.name ]]</td>
                        <td>[[ row.number ]]</td>
                        <td :title="row.office_name">[[ truncate_text(row.office_name, 20) ]]</td>
                        <td :title="row.task_name">[[ truncate_text(row.task_name, 20) ]]</td>
                        <td><span class="status-badge" style="background: #d4edda; color: #155724;">[[givestatus(row.status,row.pulled)]]</span></td>
                        <td :title="row.pulled_by">[[ truncate_text(row.pulled_by, 20) ]]</td>
                        <td>[[ row.timestamp ]]</td>
                        <td class="action-icons" >
                            <a @click="EditTicket(row.name)" >
                                <span class="mr-1 fa fa-pencil text-warning">
                                </span>
                            </a>

                            <a @click="PullTicket(row.name,row.office_id,row.ticket_id)" >
                                <span class="fa fa-minus text-primary"></span>
                            </a>
                        </td>
                    </tr>

                    <tr v-if="paginatedRows.length === 0">
                        <td :colspan="columns.length" class="text-center">
                            No data
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Pagination controls -->
    <nav aria-label="Page navigation" >
        <div class="pagination-wrapper">
            <div class="page-info">
                Page [[ currentPage ]] of [[ totalPages ]]
            </div>

            <ul class="pagination">
                <li class="page-item" :class="{ disabled: currentPage === 1 }">
                    <button class="page-link" @click="prevPage" :disabled="currentPage === 1">
                        Prev
                    </button>
                </li>

                <li
                    class="page-item"
                    v-for="page in totalPages"
                    :key="page"
                    :class="{ active: page === currentPage }"
                >
                    <button class="page-link" @click="goToPage(page)">
                        [[ page ]]
                    </button>
                </li>

                <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                    <button class="page-link" @click="nextPage" :disabled="currentPage === totalPages">
                        Next
                    </button>
                </li>
            </ul>
        </div>
    </nav>
</div>
{% endblock %}


{% block vue_data %}
    searchQuery: '',
    // pagination
    currentPage: 1,
    perPage: 10,
    rows: [],
    columns: [
            { label: 'Token'},
            { label: 'Serial Number'},
            { label: 'Office'},
            { label: 'Task'},
            { label: 'Status'},
            { label: 'Pulled By'},
            { label: 'Time'},
            { label: 'Actions'}
        ],
    openProcessTicketDialog_var: null,
    status_choices: {{ status_choices|tojson }},
    csrf_token: "{% if form and form.csrf_token is defined %}{{ form.csrf_token._value() }}{% endif %}",
    
{% endblock %}


{% block vue_methods%}
    resetAllOffices(){
        // Confirm action
        if (!confirm("Are you sure you want to reset all offices? This action cannot be undone.")) {
            return;
        }
        axios.post("{{ url_for('offices.reset_all_offices') }}")
            .then(response => {
                if (response.data.status === 'success') {
                    showSwalMessage(response.data.message);
                    this.fetchData(); // Refresh data after reset
                } else {
                    showSwalMessage("Error: " + response.data.message);
                }
            })
            .catch(error => {
                showSwalMessage("An error occurred while resetting offices.");
                console.error(error);
            });
    },
    deleteAllOfficesAndTasks(){
    // Confirm action
    if (!confirm("Are you sure you want to delete all offices and tasks? This action cannot be undone.")) {
        return;
    }
    axios.post("{{ url_for('offices.delete_all_offices_and_tasks') }}")
        .then(response => {
            if (response.data.status === 'success') {
                showSwalMessage(response.data.message);
                this.fetchData(); // Refresh data after deletion
                //reload the page to reflect changes
                location.reload();
            } else {
                showSwalMessage("Error: " + response.data.message);
            }
        })
        .catch(error => {
            showSwalMessage("An error occurred while deleting offices.");
            console.error(error);
        });
    },
    resetOneOffice(office_id){
        // Confirm action
        if (!confirm("Are you sure you want to reset this office? This action cannot be undone.")) {
           return;
        }
        axios.post("{{ url_for('offices.reset_single_office') }}",{
            office_id: office_id
        })
            .then(response => {
                if (response.data.status === 'success') {
                    showSwalMessage(response.data.message);
                    this.fetchData(); // Refresh data after reset
                } else {
                    showSwalMessage("Error: " + response.data.message);
                }
            })
            .catch(error => {
                showSwalMessage("An error occurred while resetting the office.");
                console.error(error);
            });
    },
    
    truncate_text(text, maxLength) {
        if(!text) return '';
        if (text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength) + '...';
    },
    async submitTicketForm(ticketName) {
        const formData = await this.openProcessTicketDialog_var(this.status_choices);
        if (!formData) {
            return;
        }
        const response = await axios.post("{{ url_for('offices.update_token_details') }}",{
            ticket_name: ticketName,
            status: formData.status,
            csrf_token: this.csrf_token
        });
        if (response.data.status === 'success') {
            showSwalMessage(response.data.message);
        } else {
            showSwalMessage("Error: " + response.data.message);
        }
    },

    nextPage() {
        this.goToPage(this.currentPage + 1);
    },

    prevPage() {
        this.goToPage(this.currentPage - 1);
    },
    goToPage(page) {
        if (page < 1 || page > this.totalPages) return;
        this.currentPage = page;
    },
   

    async EditTicket(ticketName) {
        // Open modal logic here
        const response = await this.submitTicketForm(ticketName);
    },
   
    givestatus(status,pulled){
        if( status == 'Waiting' && !pulled){
            return 'Not Pulled';
        }
        else if( status == 'Waiting' && pulled){
            return 'Is Pulled';
        }
        else if( status == 'Attended'){
            return 'Processing';
        }
        else if( status == 'Processed'){
            return 'Processed';
        }
        else{
            return 'Unknown';
        }
    }

{% endblock %}


{% block vue_computed %}

    totalPages() {
        return this.rows.length === 0
        ? 1
        : Math.ceil(this.rows.length / this.perPage);
    },

    filteredRows() {
        // no search â†’ return all rows
        if (!this.searchQuery) {
            return this.rows;
        }

        const q = this.searchQuery.toLowerCase();

        return this.rows.filter(row => {
            return [
                row.name,
                row.number,
                row.office_name,
                row.task_name,
                this.givestatus(row.status,row.pulled),
                row.pulled_by,
                row.timestamp
            ] 
            .filter(v => v !== null && v !== undefined)
            .some(v => String(v).toLowerCase().includes(q));
        });
    },

    paginatedRows() {
        const start = (this.currentPage - 1) * this.perPage;
        const end   = start + this.perPage;
        return this.filteredRows.slice(start, end);
    }

{% endblock %}

{% block vue_watch %}
    searchQuery() {
        
        this.currentPage = 1; // Reset to first page on new search
    }

{% endblock %}


{% block vue_mounted %}
    this.fetchData();
    this.fetchData_interval = setInterval(this.fetchData, 2000)
    
    this.openProcessTicketDialog_var = openProcessTicketDialog;

{% endblock %}


{% block vue_before_unmount %}
    clearInterval(this.fetchData_interval);
    
{% endblock %}
                    

{% block scripts %}

{% endblock %}
