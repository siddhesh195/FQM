{% extends "base.html" %}
{% block title %} FQM - {{ page_title }} {% endblock %}


{%- from "sb_manage2.html" import sb_manage with context %}
{% block sidebar %}
 {{ sb_manage() }}
{% endblock %}

{% block page_content %}
    <div>
        <input
            type="text"
            class="form-control"
            placeholder="Search tickets..."
            v-model="searchQuery"
            style="width: 250px;"
        >
    </div>

    <table class="table table-bordered table-striped table-sm">
        <thead>
            <tr>
                <th v-for="col in columns" :key="col.label">
                    [[ col.label ]]
                </th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="row in paginatedRows" :key="row.id || row.name + '-' + row.number">
                <td>[[ row.name ]]</td>
                <td>[[ row.number ]]</td>
                <td>[[ row.office_name ]]</td>
                <td>[[ row.task_name ]]</td>
                <td>[[ row.status ]]</td>
                <td>[[ row.pulled_by ]]</td>
                <td>[[ row.pulled ? 'Yes' : 'No' ]]</td>
                <td>[[ row.timestamp ]]</td>
                <td>
                    <a @click="EditTicket(row.name)" >
                        <span class="mr-1 fa fa-pencil text-warning">
                        </span>
                    </a>

                    <a @click="PullTicket(row.name,row.office_id,row.ticket_id)" >
                        <span class="fa fa-minus text-primary"></span>
                    </a>
                </td>
            </tr>
            <tr v-if="paginatedRows.length === 0">
                <td :colspan="columns.length" class="text-center">
                    No data
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation" class="d-flex justify-content-between align-items-center">
        <div>
            Page [[ currentPage ]] of [[ totalPages ]]
        </div>

        <ul class="pagination mb-0">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <button class="page-link" @click="prevPage" :disabled="currentPage === 1">
                    Prev
                </button>
            </li>

            <li
                class="page-item"
                v-for="page in totalPages"
                :key="page"
                :class="{ active: page === currentPage }"
            >
                <button class="page-link" @click="goToPage(page)">
                    [[ page ]]
                </button>
            </li>

            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <button class="page-link" @click="nextPage" :disabled="currentPage === totalPages">
                    Next
                </button>
            </li>
        </ul>
    </nav>

{% endblock %}


{% block scripts %}

<script type="module">

    import { createApp, markRaw } from "{{ url_for('static', filename='vendor/vue/vue.esm-browser.prod.js') }}";


    const app =createApp({
        delimiters: ['[[', ']]'],
    
        data() {
            return {
                rows: [],
                columns: [
                    { label: 'Token Name'},
                    { label: 'Number'},
                    { label: 'Office'},
                    { label: 'Task'},
                    { label: 'Status'},
                    { label: 'Pulled By'},
                    { label: 'Pulled?'},
                    { label: 'Time'},
                    { label: 'Actions'}
                ],
                // pagination
                currentPage: 1,
                perPage: 10,   // change as you like
                csrf_token: "{% if form.csrf_token is defined %}{{ form.csrf_token._value() }}{% endif %}",
                openProcessTicketDialog_var: null,
                status_choices: {{ status_choices|tojson }},
                active_tickets_number: '',
                searchQuery: ''
            };
        },

        methods: {
            fetchData() {
                axios.post("{{ url_for('offices.all_offices_tickets') }}",{
                    o_id: {% if office_id is not none %}{{ office_id }}{% else %}null{% endif %}
                })
                    .then(response => {
                        this.rows = response.data;
                       
                    })
                    .catch(error => {
                        console.error("Error fetching data:", error);
                    });      
            },

            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.currentPage = page;
            },

            nextPage() {
                this.goToPage(this.currentPage + 1);
            },

            prevPage() {
                this.goToPage(this.currentPage - 1);
            },
            async EditTicket(ticketName) {
                // Open modal logic here
                const response = await this.submitTicketForm(ticketName);
                
            },
            PullTicket(ticketName,officeId,ticketId) {
              
                axios.post("{{ url_for('offices.pull_ticket') }}", {
                    ticket_name: ticketName,
                    office_id: officeId,
                    ticket_id: ticketId
                })
                .then(response => {
                    this.fetchData();  // Refresh data after pulling
                    if (response.data.status === 'success') {
                        showSwalMessage("Successfully pulled ticket: " + ticketName);
                    } else {
                        showSwalMessage("Error: " + response.data.message);
                    }
                   
                })
                .catch(error => {
                    console.error("Error pulling ticket:", error);
                });
            },

            async submitTicketForm(ticketName) {
                const formData = await this.openProcessTicketDialog_var(this.status_choices);
                if (!formData) {
                    return;
                }
                const response = await axios.post("{{ url_for('offices.update_token_details') }}",{
                    ticket_name: ticketName,
                    status: formData.status,
                    csrf_token: this.csrf_token
                });
                if (response.data.status === 'success') {
                    showSwalMessage(response.data.message);
                } else {
                    showSwalMessage("Error: " + response.data.message);
                }
            },

            getNumberOfActiveTickets() {
                axios.get("{{ url_for('offices.get_all_active_tickets') }}")
                    .then(response => {
                        this.active_tickets_number = response.data.active_tickets;
                    })
                    .catch(error => {
                        console.error("Error fetching active tickets:", error);
                        
                    });
            },
            pullTicket() {
                axios.post("{{ url_for('offices.pull_next_ticket') }}", {
                    o_id: null,
                    ofc_id: null
                })
                .then(response => {
                    this.fetchData();  // Refresh data after pulling
                    if (response.data.status === 'success') {
                        showSwalMessage(response.data.message);
                    } else {
                        showSwalMessage("Error: " + response.data.message);
                    }
                   
                })
                .catch(error => {
                    console.error("Error pulling ticket:", error);
                });
            }
        },

        computed:{

            totalPages() {
                return this.rows.length === 0
                    ? 1
                    : Math.ceil(this.rows.length / this.perPage);
            },

            filteredRows() {
                // no search â†’ return all rows
                if (!this.searchQuery) {
                    return this.rows;
                }

                const q = this.searchQuery.toLowerCase();

                return this.rows.filter(row => {
                    return [
                        row.name,
                        row.number,
                        row.office_name,
                        row.task_name,
                        row.status,
                        row.pulled_by,
                        row.timestamp
                   ] 
                   .filter(v => v !== null && v !== undefined)
                   .some(v => String(v).toLowerCase().includes(q));
                });
            },

            paginatedRows() {
                const start = (this.currentPage - 1) * this.perPage;
                const end   = start + this.perPage;
                return this.filteredRows.slice(start, end);
            }
        },
        
        mounted() {

            this.fetchData();
            this.intervalId = setInterval(this.fetchData, 2000)
            this.intervalId2 = setInterval(this.getNumberOfActiveTickets, 2000)
            this.openProcessTicketDialog_var = openProcessTicketDialog;
        
        },
        beforeUnmount() {
            clearInterval(this.intervalId);
        }
    });
   
    app.mount('#all_offices_app');
   
</script>

{% endblock %}
