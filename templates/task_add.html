<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->

{% extends "base.html" %}
{% block title %} FQM - {{ page_title  }} {% endblock %}

{%- from "sb_manage2.html" import sb_manage with context %}
{% block sidebar %}
{{ sb_manage() }}
{% endblock %}

{% block page_content %}
{% from "_helpers.html" import render_field with context %}
{% from '_modals.html' import qrModal %}
<div class="col-md-12">
	<form method="POST" enctype="multipart/form-data" id="fm">
		<div class="panel panel-default">
	  	<div class="panel-heading text-center">
    		<h3 class="text-muted"><strong><span class="fa fa-plus"></span> {{ translate('Add new task', 'en', [defLang]) }} </strong></h3>
	    </div>
	    <div class="panel-body">
			{{ form.csrf_token }}
			<a data-toggle="modal" data-target="#mym">
		    <center><img class="img-responsive mt-5 mb-2 img-thumbnail" id="map" width="40%" src="{{ url_for('static', filename='images/manage_task.jpg') }}"></center>
			</a>
			<p class="h3 text-center text-muted ar2">
		    	| {{ translate("Task : the option that its title appears to the user on the Touch screen to choose from and dispatch a ticket for it", 'en', [defLang]) }} |
			</p>
			<hr class='mb-4'>
			{{ render_field(form.name, class="form-control", **{'v-model': 'task_name', 'length': 60}) }}
			{{ render_field(form.hidden, class="form-control", **{'v-model': 'task_hidden'}) }}
			{% if common %}
			<p class="h4 text-center text-muted ar2 pt-2 pb-1">
				| {{ translate("Select the offices to add the common task to :", 'en', [defLang]) }} |
			</p>
			{% for ofc in offices.all() %}
			{{ render_field(form['check' + str(ofc.id)],class="form-control",**{'v-model': 'office_checks[' ~ ofc.id ~ ']'}) }}
			{% endfor %}
			{% endif %}
			<p class="pt-6"></p>
			<center>
				<button @click="addTask" type="button" class="btn btn-md btn-danger">{{ translate('Add task', 'en', [defLang]) }}</button>
    		</center>
    		<p class="pb-2"></p>
	    </div>
		</div>
  </form>
</div>

{{ qrModal([['mym', translate('Management template', 'en', [defLang]), url_for('static', filename='images/manage_map.jpg')]], close=translate('Exit', 'en', [defLang])) }}
{% endblock %}

{% block vue_data %}
task_name: '',
task_hidden: false,
office_checks: {},
csrf_token:  "{% if form and form.csrf_token is defined %}{{ form.csrf_token._value() }}{% endif %}",
o_id: {% if o_id is defined and o_id %}{{ o_id }}{% else %}null{% endif %},
add_task_url: "{% if o_id is defined and o_id %}{{ url_for('tasks.add_task', o_id=o_id) }}{% else %}{{ url_for('tasks.add_common_task') }}{% endif %}",



{% endblock %}

{% block vue_methods %}


async addTask() {
	
	try {
		const payload = {
			name: this.task_name,
			hidden: this.task_hidden,
			csrf_token: this.csrf_token
		};
		if (this.office_checks) {
		    for (const [id, val] of Object.entries(this.office_checks)) {
                if (val) {
                    payload[`check${id}`] = true;
                }else{
					payload[`check${id}`] = false;
				}
				}
            }
			const response = await axios.post(this.add_task_url, payload);
		if (response.data.status === 'success') {
            const result = await showSwalMessage(response.data.message);

            if (result.isConfirmed) {
                window.location.reload();
            }

            this.office_name = '';
            this.office_prefix = '';
        } else {
            await showSwalMessage(response.data.message);
        }
		
		
	} catch (error) {
		console.error('Error:', error);
		alert('An error occurred while adding the task.');
	}
}


{% endblock %}



{% block vue_mounted %}

console.log('Vue instance mounted for adding task.');
{% endblock %}

{% block  vue_watch %}

office_checks: {
    handler(newVal) {
        
    },
    deep: true
},
task_hidden(newVal) {
	
},
task_name(newVal) {
	
},

{% endblock %}

