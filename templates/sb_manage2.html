<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->

{% macro sb_manage() %}

<div class="col-md-2 sidebar">
    <div class="row">
	<!-- uncomment code for absolute positioning tweek see top comment in css -->
	<div class="absolute-wrapper"> </div>
	<!-- Menu -->
	<div class="side-menu">
	    <nav class="navbar navbar-default" style="font-size: large;" role="navigation">
		<!-- Main Menu -->
		<div class="side-menu-container">
		    <ul class="nav navbar-nav">
			{% if getattr(current_user, 'role_id', None) != 3 or settings.single_row %}
			
			<li id="da2" >
			    <a href="{{ url_for('offices.offices_home') }}">
				    <span class="fa fa-ticket"></span>
				    {{ translate('All tickets', 'en', [defLang]) }}
				    {% if not settings.single_row %}
				        <span class="badge pull-right">
					        [[ active_tickets_number ]]
				        </span>
				    {% endif %}
			    </a>
			</li>
			<li >
				<a @click="pullnextTicket()">
						<span class="fa fa-{% if settings.single_row %}plus{% else %}minus{% endif %}"></span>
						{{ translate('Generate a ticket' if settings.single_row else 'Pull a ticket', 'en', [defLang]) }}
						
						<span class="badge pull-right">
							[[ active_tickets_number ]]
						</span>
				</a>
			</li>
			{% if not settings.single_row %}
			<li id="da3">
			    <a href="{{ url_for('offices.add_office') }}">
				<span class="fa fa-plus"></span>
				{{ translate('Add new office', 'en', [defLang]) }}
			    </a>
			</li>
			{% if current_user.role_id==1 %}
			<li id="da5" >
			    <a href="{{ url_for('manage_app2.manage_home') }}">
				<span ></span>
				{{ translate('Manage Home', 'en', [defLang]) }}
			    </a>

			{% endif %}
			{% if offices.count() > 1 %}
			<li id="da6" >
			    <a href="{{ url_for('manage_app.common_task_a') }}">
				<span class="fa fa-plus"></span>
				{{ translate('Add common task', 'en', [defLang]) }}
			    </a>
			</li>
			{% endif %}
			{% endif %}
			<li id="da4" >
				<a onclick="announce('{{ current_user.id }}')">
				<span class="glyphicon glyphicon-refresh"></span>
				{{ translate('Repeat announcement', 'en', [defLang]) }}
				</a>
			</li>
			{% endif %}
			{% if not settings.single_row and current_user.role_id==1%}
			    <li>
				    <a href="{{ url_for('reports.reports_home') }}">
			    		<span class="fa "></span>
			    		<strong>View Reports</strong>
					</a>
				</li>
			{% endif %}
			<!-- Dropdown--> 
			{% if not settings.single_row %}
			{% for office in offices %}
			{% if getattr(current_user, 'role_id', None) != 3 or is_office_operator(current_user, office) %}
			<li class="panel panel-default da{{ office.id+3 }} {% if ar %} ar1 {% endif %}" id="dropdown">
			    <a data-toggle="collapse" href="#dropdown-lvl{{ office.id }}">
				<span class="fa fa-desktop"></span>
				{{ loop.index }}.{{ translate('Office', 'en', [defLang]) }}  {{ office.prefix }}
				
				{% if office.name and office.name|length < 8 %}
                    {{ office.name }}
				{% elif office.name %}
					 <span title="{{ office.name }}">- {{ office.name[:8] }}...</span>
                {% endif %}
				
				
				<span class="caret"></span>
				<!-- To solve counting all the common and non-common tasks tickets -->
				<span class="badge pull-right">
					[[active_tickets_office[{{office.id}}] ]]
				</span>
			
			    </a>
			    <!-- Dropdown level 1 -->
			    <div id="dropdown-lvl{{ office.id }}" class="panel-collapse collapse">
				<div class="panel-body">
				    <ul class="nav navbar-nav">
					<li >
					    <a href="{{ url_for('offices.offices_home', o_id=office.id) }}">
						<span class="fa fa-ticket"></span>
						{{ translate('All tickets', 'en', [defLang]) }}
					    </a>
					</li>
					<li id="tr{{ office.id }}" >
						<a onclick="announce('{{ current_user.id }}','{{ office.id }}')">
						<span class="glyphicon glyphicon-refresh"></span>
						{{ translate('Repeat announcement', 'en', [defLang]) }}
						</a>
					</li>
					<li  id="to{{ office.id }}" >
						<a href="{{ url_for('administrate.operators', t_id=office.id) }}">
						<span class="fa fa-user"></span>
						{{ translate('Operators', 'en', [defLang]) }}
						<span class="badge pull-right">
							{{ operators.filter_by(office_id=office.id).count() }}
						</span>
						</a>
					</li>
			<!-- Fix: pulling tickets by task_id instead of office_id -->
			<!-- Will include pull ticket under task instead of all tickets, fast and simple -->
			        {% if current_user.role_id==1 %}
					<li  id="t3{{ office.id }}" >
					    <a href="{{ url_for('manage_app.task_a', o_id=office.id) }}">
						<span class="fa fa-plus"></span>
						{{ translate('Add new task', 'en', [defLang]) }}
					    </a>
					</li>
				    {% endif %}
					{% for task in tasks.in_offices(office.id) %}
					<li id="tt{{office.id }}{{ task.id }}" >
					 
						{{ loop.index }}.

						{% if task.name and task.name|length < 20 %}
                            {{ task.name }}
				       {% elif task.name %}
					        <span title="{{ task.name }}">- {{ task.name[:20] }}...</span>
                       {% endif %}
					    
					</li>
					<!-- Pull is shifted to here -->
					<li>
						<a @click="pullnextTicket( {{ task.id }}, {{ office.id }} )">
								<span class="fa fa-minus"></span>
								{{ translate('Pull a ticket', 'en', [defLang]) }}
								<span class="badge pull-right">
								    <div v-if="active_tickets_task_by_office[{{office.id}}] && active_tickets_task_by_office[{{office.id}}][{{task.id}}] !== undefined">
										[[ active_tickets_task_by_office[{{office.id}}][{{task.id}}] ]]
									</div>
									
								</span>
						</a>
					</li>
					{% endfor %}
				    </ul>
				</div>
			    </div>
			</li>

			{% endif %}
			{% endfor %}
			{% endif %}
		    </ul>
		</div><!-- /.navbar-collapse -->
	    </nav>
	</div>
    </div>
</div>

{% endmacro %}
